<!DOCTYPE html>
<html lang="en" x-data="dashboard()" x-init="init()">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bybit Order Dashboard</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <style>
      :root {
        --fg: #e6e6e6;
        --bg: #0b0b0b;
        --muted: #9aa0a6;
        --ok: #0ecb81;
        --bad: #f6465d;
        --card: #121212;
        --line: #1f1f1f;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        background: var(--bg);
        color: var(--fg);
      }
      .wrap {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      select,
      button,
      input {
        background: var(--card);
        border: 1px solid var(--line);
        color: var(--fg);
        padding: 6px 10px;
        border-radius: 8px;
      }
      button {
        cursor: pointer;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        margin: 12px 0;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 8px;
      }
      h2 {
        font-size: 16px;
        margin: 0 0 8px;
        color: var(--muted);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-top: 1px solid var(--line);
        padding: 8px 6px;
        text-align: left;
        vertical-align: middle;
      }
      th {
        color: #bdbdbd;
        font-weight: 600;
        background: #151515;
        position: sticky;
        top: 0;
      }
      .right {
        text-align: right;
      }
      .muted {
        color: var(--muted);
      }
      .good {
        color: var(--ok);
      }
      .bad {
        color: var(--bad);
      }
      .pill {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #161616;
      }
      .error {
        color: #fff;
        background: var(--bad);
        padding: 8px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="row">
        <h1>Bybit Order Dashboard</h1>
        <span class="pill" x-text="connected ? 'Proxy: OK' : 'Proxy: …'"></span>
        <span class="muted" x-show="loading">Loading…</span>
        <span
          class="muted"
          x-text="lastUpdated ? ('Updated: ' + lastUpdated) : ''"
        ></span>
      </div>

      <div class="card">
        <div class="row">
          <label
            >Environment
            <select x-model="env" @change="fetchAll()">
              <option value="testnet">Testnet</option>
              <option value="mainnet">Mainnet</option>
            </select>
          </label>
          <label
            >Proxy
            <input type="text" size="26" x-model="baseUrl" />
          </label>
          <button @click="fetchAll()">Refresh</button>
          <button
            @click="toggleAuto()"
            x-text="auto ? 'Auto: ON' : 'Auto: OFF'"
          ></button>
          <span class="muted">every 5s</span>
        </div>
        <div class="row">
          <label
            >Token
            <input
              type="password"
              size="36"
              x-model="token"
              placeholder="PROXY_BEARER_TOKEN"
            />
          </label>
        </div>
        <div class="row" x-show="error">
          <div class="error" x-text="error"></div>
        </div>
      </div>

      <div class="card">
        <h2>Account Summary</h2>
        <div
          x-show="wallet"
          style="
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
          "
        >
          <div>
            Total Balance<br /><strong
              x-text="fmt(wallet.totalWalletBalance) + ' USDT'"
            ></strong>
          </div>
          <div>
            Available<br /><strong
              x-text="fmt(wallet.totalAvailableBalance) + ' USDT'"
            ></strong>
          </div>
          <div>
            Total UPL<br />
            <strong
              :class="wallet.totalPerpUPL >= 0 ? 'good' : 'bad'"
              x-text="fmt(wallet.totalPerpUPL) + ' USDT'"
            ></strong>
          </div>
        </div>
        <div class="muted" x-show="!wallet">No wallet data.</div>
      </div>

      <div class="card">
        <h2>Positions</h2>
        <div style="overflow: auto; max-height: 340px">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Side</th>
                <th class="right">Size</th>
                <th class="right">Avg Price</th>
                <th class="right">Mark</th>
                <th class="right">UPL</th>
                <th class="right">UPL %</th>
                <th class="right">Value</th>
              </tr>
            </thead>
            <tbody>
              <template
                x-for="pos in positions"
                :key="pos.symbol + '-' + pos.side"
              >
                <tr>
                  <td x-text="pos.symbol"></td>
                  <td x-text="pos.side"></td>
                  <td class="right" x-text="fmt(pos.size)"></td>
                  <td class="right" x-text="fmt(pos.avgPrice)"></td>
                  <td class="right" x-text="fmt(pos.markPrice)"></td>
                  <td
                    class="right"
                    :class="+pos.unrealisedPnl >= 0 ? 'good' : 'bad'"
                    x-text="fmt(pos.unrealisedPnl) + ' USDT'"
                  ></td>
                  <td
                    class="right"
                    :class="pnlPct(pos) >= 0 ? 'good' : 'bad'"
                    x-text="pnlPct(pos).toFixed(2) + '%'"
                  ></td>
                  <td
                    class="right"
                    x-text="fmt(pos.positionValue) + ' USDT'"
                  ></td>
                </tr>
              </template>
              <tr x-show="positions.length === 0">
                <td colspan="8" class="muted">No positions</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Active Orders</h2>
        <div style="overflow: auto; max-height: 360px">
          <table>
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Side</th>
                <th>Type</th>
                <th class="right">Qty</th>
                <th class="right">Price</th>
                <th>Status</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="order in orders" :key="order.orderId">
                <tr>
                  <td x-text="order.symbol"></td>
                  <td x-text="order.side"></td>
                  <td x-text="order.orderType"></td>
                  <td class="right" x-text="fmt(order.qty)"></td>
                  <td
                    class="right"
                    x-text="order.price ? fmt(order.price) : 'Market'"
                  ></td>
                  <td x-text="order.orderStatus"></td>
                  <td x-text="ts(order.createdTime)"></td>
                  <td>
                    <button @click="cancelOrder(order.orderId, order.symbol)">
                      Cancel
                    </button>
                  </td>
                </tr>
              </template>
              <tr x-show="orders.length === 0">
                <td colspan="8" class="muted">No active orders</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      function dashboard() {
        return {
          // ====== CONFIG ======
          env: 'testnet',
          baseUrl: 'http://127.0.0.1:8080/proxy',
          token: 'put_a_long_random_token_here', // <-- set to your PROXY_BEARER_TOKEN
          auto: true,
          intervalMs: 5000,

          // ====== STATE ======
          loading: false,
          error: null,
          connected: false,
          lastUpdated: null,
          positions: [],
          orders: [],
          wallet: null,
          _timer: null,

          // ====== LIFECYCLE ======
          async init() {
            await this.fetchAll();
            this._schedule();
          },
          toggleAuto() {
            this.auto = !this.auto;
            this._schedule();
          },
          _schedule() {
            if (this._timer) clearInterval(this._timer);
            if (this.auto) {
              this._timer = setInterval(() => this.fetchAll(), this.intervalMs);
            }
          },

          // ====== HELPERS ======
          hdrs(endpoint, isPost = false) {
            const h = {
              Authorization: this.token ? `Bearer ${this.token}` : '',
              'X-Target-Endpoint': endpoint,
              'X-Target-Env': this.env
            };
            if (isPost) h['Content-Type'] = 'application/json';
            return h;
          },
          fmt(x) {
            if (x === null || x === undefined) return '';
            const n = Number(x);
            if (!isFinite(n)) return String(x);
            return n.toLocaleString(undefined, { maximumFractionDigits: 6 });
          },
          ts(ms) {
            if (!ms) return '';
            const d = new Date(parseInt(ms));
            return d.toLocaleString();
          },
          pnlPct(pos) {
            const upnl = parseFloat(pos.unrealisedPnl || 0);
            const val = parseFloat(pos.positionValue || 0);
            if (!val) return 0;
            return (upnl / val) * 100;
          },

          // ====== FETCHERS ======
          async fetchAll() {
            this.loading = true;
            this.error = null;
            try {
              await Promise.all([
                this.fetchWallet(),
                this.fetchPositions(),
                this.fetchOrders()
              ]);
              this.connected = true;
              this.lastUpdated = new Date().toLocaleTimeString();
            } catch (e) {
              this.error = e?.message || String(e);
              this.connected = false;
            } finally {
              this.loading = false;
            }
          },

          async fetchWallet() {
            const url = `${this.baseUrl}?accountType=UNIFIED`;
            const res = await fetch(url, {
              headers: this.hdrs('/v5/account/wallet-balance')
            });
            if (res.status === 401)
              throw new Error('401 Unauthorized: check PROXY_BEARER_TOKEN');
            const data = await res.json();
            if (data.retCode === 0 && data.result?.list?.length) {
              this.wallet = data.result.list[0];
            } else if (data.retMsg) {
              throw new Error(data.retMsg);
            }
          },

          async fetchPositions() {
            const url = `${this.baseUrl}?category=linear&settleCoin=USDT`;
            const res = await fetch(url, {
              headers: this.hdrs('/v5/position/list')
            });
            if (res.status === 401)
              throw new Error('401 Unauthorized: check PROXY_BEARER_TOKEN');
            const data = await res.json();
            if (data.retCode === 0) {
              this.positions = data.result?.list || [];
            } else if (data.retMsg) {
              throw new Error(data.retMsg);
            }
          },

          async fetchOrders() {
            const url = `${this.baseUrl}?category=linear&settleCoin=USDT`;
            const res = await fetch(url, {
              headers: this.hdrs('/v5/order/realtime')
            });
            if (res.status === 401)
              throw new Error('401 Unauthorized: check PROXY_BEARER_TOKEN');
            const data = await res.json();
            if (data.retCode === 0) {
              this.orders = data.result?.list || [];
            } else if (data.retMsg) {
              throw new Error(data.retMsg);
            }
          },

          async cancelOrder(orderId, symbol) {
            if (!confirm('Cancel order?')) return;
            const body = JSON.stringify({
              category: 'linear',
              symbol,
              orderId
            });
            const res = await fetch(this.baseUrl, {
              method: 'POST',
              headers: this.hdrs('/v5/order/cancel', true),
              body
            });
            if (res.status === 401) {
              alert('401 Unauthorized: check token');
              return;
            }
            const data = await res.json();
            if (data.retCode === 0) {
              await this.fetchOrders();
            } else {
              alert('Failed: ' + (data.retMsg || 'Unknown error'));
            }
          }
        };
      }
    </script>
  </body>
</html>
